<!doctype html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注册</title>
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=RobotoDraft:300,500">
    <link rel="stylesheet" type="text/css" href="__STATIC__/build/css/default.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/build/css/animate.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/build/css/account.css" />
    <style type="text/css">
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0;
        }
        
        .logo {
            margin: 20px;
            width: 7%;
            height: 7%;
        }
        
        @media only screen and (max-width: 768px) {
            .zhuceanniu {
                margin-right: 20%;
            }
            .paizhaoanniu {
                margin-right: 20%;
            }
        }
    </style>
</head>

<body>
    <div class="htmleaf-container">
        <image src="__STATIC__/build/img/logo.png" class="logo"></image>
        <h1 class="title" style="color:whitesmoke">智能众包管理平台</h1>
        <div class="login">
            <div class="photo">
                <div id='false_camera'></div>
                <div id="true_camera"></div>
            </div>
            <span>注 册 您 的 用 户</span>
            <form action="" id="login-form">
                <div class="stepone " style=" position: absolute;">
                    <div id="u" class="form-group">
                        <input id="username" spellcheck=false class="form-control" name="UserName" type="text" size="18" alt="register" required="">
                        <span class="form-highlight"></span>
                        <span class="form-bar"></span>
                        <label for="username" class="float-label"><strong>姓名</strong></label>
                        <erroru>
                            <strong>请填写姓名</strong>
                            <i>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24h-24z" fill="none" />
                                    <path d="M1 21h22l-11-19-11 19zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                                </svg>
                            </i>
                        </erroru>
                    </div>
                    <div id="n" class="form-group">
                        <input id="number" spellcheck=false class="form-control" name="PhoneNumber" type="number" size="18" alt="register" required="">
                        <span class="form-highlight"></span>
                        <span class="form-bar"></span>
                        <label for="number" class="float-label"><strong>手机号</strong></label>
                        <errorn>
                            <strong>请填写手机号</strong>
                            <i>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24h-24z" fill="none" />
                                    <path d="M1 21h22l-11-19-11 19zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                                </svg>
                            </i>
                        </errorn>
                    </div>
                    <div id="c" class="form-group">
                        <input id="company" spellcheck=false class="form-control" name="Company" type="text" size="18" alt="register" required="">
                        <span class="form-highlight"></span>
                        <span class="form-bar"></span>
                        <label for="company" class="float-label"><strong>公司</strong></label>
                        <errorc>
                            <strong>请填写公司</strong>
                            <i>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24h-24z" fill="none" />
                                    <path d="M1 21h22l-11-19-11 19zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                                </svg>
                            </i>
                        </errorc>
                    </div>
                    <p>
                        <a href="{:url('index/login/index')}">返回登录界面</a>
                    </p>
                    <button id="next" type="button">下一步</button>
                </div>
                <div class="steptwo" style="display: none; position: absolute;">
                    <div id="p" class="form-group">
                        <input id="password" class="form-control" spellcheck=false name="Password" type="password" size="18" alt="register" required="">
                        <span class="form-highlight"></span>
                        <span class="form-bar"></span>
                        <label for="password" class="float-label"><strong>密码</strong></label>
                        <errorp>
                            <strong>请填写密码</strong>
                            <i>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24h-24z" fill="none" />
                                    <path d="M1 21h22l-11-19-11 19zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                                </svg>
                            </i>
                        </errorp>
                    </div>
                    <div id="o" class="form-group">
                        <input id="passwordo" class="form-control" spellcheck=false name="C-password" type="password" size="18" alt="register" required="">
                        <span class="form-highlight"></span>
                        <span class="form-bar"></span>
                        <label for="passwordo" class="float-label"><strong>确认密码</strong></label>
                        <erroro>
                            <strong>请确认密码</strong>
                            <i>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M0 0h24v24h-24z" fill="none" />
                                    <path d="M1 21h22l-11-19-11 19zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                                </svg>
                            </i>
                        </erroro>
                    </div>
                    <div id='f' class="form-group ">
                        <button id='collectFace' type='button' ripple class="paizhaoanniu">拍照</button>
                        <input id="phonepicture" name='imgData' type="file" accept="image/png" capture="camera" hidden style="float:right">

                        <input disabled id="facepath" class="form-control" spellcheck=false name="FaceInformation" type="text" size="18" alt="register" required="">
                        <span class="form-highlight"></span>
                        <span class="form-bar"></span>
                        <label for="facepath" class="float-label"><strong>人脸信息</strong></label>
                    </div>
                    <div class="form-group">
                        <button style='float:left' id='previous' type='button' ripple>上一步</button>
                        <button id="submit" type="submit" ripple class="zhuceanniu">注册</button>
                        <br>
                        <br>
                        <p>
                            <a href="{:url('index/login/index')}">返回登录界面</a>
                        </p>
                    </div>
            </form>
            </div>
        </div>
        <h4 class="copyright" style="color:whitesmoke">众包平台@吃瓜小队 制作 V2.0.5</h4>

        <script src='__STATIC__/vendors/jquery/dist/jquery.min.js'></script>
        <script src="__STATIC__/build/js/login-jquery.backstretch.min.js"></script>
        <script src="__STATIC__/vendors/camera/camera.js"></script>
        <script src="__STATIC__/vendors/sweetalert-master/sweetalert.js"></script>
        <script src="__STATIC__/vendors/BugFix/mobileBUGFix.mini.js"></script>
        <script>
            $("body").css({
                "font-weight": 900
            });
        </script>
        <script>
            function isPoneAvailable($poneInput) {
                var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
                if (!myreg.test($poneInput)) {
                    return false;
                } else {
                    return true;
                }
            }
            //检测是否为手机端访问
            var phone = false;
            if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
                var phoneCamera = $("#phonepicture");
                phoneCamera.show();
                $("#collectFace").hide();
                phone = true;
            }

            function getNowFormatDate() {
                var date = new Date();
                var seperator1 = "-";
                var seperator2 = ":";
                var month = date.getMonth() + 1;
                var strDate = date.getDate();
                if (month >= 1 && month <= 9) {
                    month = "0" + month;
                }
                if (strDate >= 0 && strDate <= 9) {
                    strDate = "0" + strDate;
                }
                var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate +
                    " " + date.getHours() + seperator2 + date.getMinutes();
                return currentdate;
            }
            if (!phone) {
                //真摄像头，实际拍照的
                var camera = new Camera('true_camera', {
                    needEdit: true,
                    imageType: 'png',
                    width: 400,
                    height: 300
                });
                //假摄像头，放在页面上看看的
                var falsecamera = new Camera('false_camera', {
                    needEdit: true,
                    imageType: 'png',
                    width: 140,
                    height: 150
                });
                camera.init();
                falsecamera.init();
                //调整摄像头位置
                $('video').css('right', 20);
                $('video').css('bottom', 15);
                //隐藏摄像头
                $('#true_camera').hide();
                $('#false_camera').hide();
            }
            $(document).ready(function() {
                //人脸图片的文件夹名
                var dirname = null;
                //记录目前已经拍摄了几张人脸
                var face_number = 0;
                //记录最大的允许拍摄人脸数量
                var max_face_number = 4;
                //上一张照片
                var old_img = null;
                $(function() {
                    var animationLibrary = 'animate';
                    $.easing.easeOutQuart = function(x, t, b, c, d) {
                        return -c * ((t = t / d - 1) * t * t * t - 1) + b;
                    };
                    $('[ripple]:not([disabled],.disabled)').on('mousedown', function(e) {
                        var button = $(this);
                        var touch = $('<touch><touch/>');
                        var size = button.outerWidth() * 1.8;
                        var complete = false;
                        $(document).on('mouseup', function() {
                            var a = {
                                'opacity': '0'
                            };
                            if (complete === true) {
                                size = size * 1.33;
                                $.extend(a, {
                                    'height': size + 'px',
                                    'width': size + 'px',
                                    'margin-top': -size / 2 + 'px',
                                    'margin-left': -size / 2 + 'px'
                                });
                            }
                            touch[animationLibrary](a, {
                                duration: 500,
                                complete: function() {
                                    touch.remove();
                                },
                                easing: 'swing'
                            });
                        });
                        touch.addClass('touch').css({
                            'position': 'absolute',
                            'top': e.pageY - button.offset().top + 'px',
                            'left': e.pageX - button.offset().left + 'px',
                            'width': '0',
                            'height': '0'
                        });
                        button.get(0).appendChild(touch.get(0));
                        touch[animationLibrary]({
                            'height': size + 'px',
                            'width': size + 'px',
                            'margin-top': -size / 2 + 'px',
                            'margin-left': -size / 2 + 'px'
                        }, {
                            queue: false,
                            duration: 500,
                            'easing': 'easeOutQuart',
                            'complete': function() {
                                complete = true;
                            }
                        });
                    });
                });
                var username = $('#username'),
                    number = $('#number'),
                    company = $('#company'),
                    password = $('#password'),
                    passwordo = $('#passwordo'),
                    erroru = $('erroru'),
                    errorn = $('errorn'),
                    errorc = $('errorc'),
                    errorp = $('errorp'),
                    erroro = $('erroro'),
                    submit = $('#submit'),
                    udiv = $('#u'),
                    ndiv = $('#n'),
                    cdiv = $('#c'),
                    pdiv = $('#p'),
                    odiv = $('#o');
                username.blur(function() {
                    if (username.val() == '') {
                        udiv.attr('errr', '');
                    } else {
                        udiv.removeAttr('errr');
                    }
                });
                number.blur(function() {
                    if (number.val() == '') {
                        ndiv.attr('errr', '');
                    } else {
                        ndiv.removeAttr('errr');
                    }
                });
                company.blur(function() {
                    if (company.val() == '') {
                        cdiv.attr('errr', '');
                    } else {
                        cdiv.removeAttr('errr');
                    }
                });
                password.blur(function() {
                    if (password.val() == '') {
                        pdiv.attr('errr', '');
                    } else {
                        pdiv.removeAttr('errr');
                    }
                });
                passwordo.blur(function() {
                    if (passwordo.val() == '') {
                        odiv.attr('errr', '');
                    } else {
                        if (passwordo.val() != password.val()) {
                            odiv.attr('errr', '');
                        } else {
                            odiv.removeAttr('errr');
                        }
                    }
                });
                submit.on('click', function(event) {
                    event.preventDefault();
                    //用户名
                    if (username.val() == '') {
                        udiv.attr('errr', '');
                    } else {
                        udiv.removeAttr('errr');
                    }
                    //号码
                    if (number.val() == '') {
                        ndiv.attr('errr', '');
                    } else {
                        ndiv.removeAttr('errr');
                    }
                    //公司
                    if (company.val() == '') {
                        cdiv.attr('errr', '');
                    } else {
                        cdiv.removeAttr('errr');
                    }
                    //密码
                    if (password.val() == '') {
                        pdiv.attr('errr', '');
                    } else {
                        pdiv.removeAttr('errr');
                    }
                    //密码重复
                    if (passwordo.val() == '' || passwordo.val() != password.val()) {
                        odiv.attr('errr', '');
                    } else {
                        odiv.removeAttr('errr');
                    }

                    if (username.val() == '' || number.val() == '' || company.val() == '') {
                        $(".stepone").removeClass("animated zoomOut");
                        $(".steptwo").hide();
                        $(".steptwo").removeClass("animated fadeInUp");
                        $('#false_camera').hide(); //显示摄像头
                        //改变摄像头框的样式
                        $('div.camera').addClass('photo');
                        $('div.photo').removeClass('camera');
                    } else if (dirname == null) {
                        swal("人脸信息错误", "至少需要1张人脸信息", "error");
                    } else {
                        //判断公司是否存在
                        $.post("/tp5/public/index.php/api/Companies/getcompanyid/name/" + $("input#company").val()).done(function(data) {
                            if (data.status != 0) {
                                $("#facepath").attr("disabled", false);
                                //判断散户的情况
                                if (data.status == 2) $("input#company").val(0);
                                else $("input#company").val(data.id);
                                //进行注册
                                if (isPoneAvailable($("input[name='PhoneNumber']").val())) {


                                    $.post("/tp5/public/index.php/api/Users/register", {
                                        UserName: username.val(),
                                        Password: password.val(),
                                        FaceInformation: dirname,
                                        PhoneNumber: number.val(),
                                        Gender: 'unknown',
                                        Company: company.val(),
                                        WorkTime: 0,
                                        Jointime: getNowFormatDate()
                                    }).done(function(data) {
                                        if (data.status == 1) {
                                            swal("注册成功", "请等待管理员审核账号", "success").then((ok) => {
                                                if (ok) window.location.href = "/tp5/public/index.php/index/Login/index";
                                            });
                                        }
                                    });
                                } else {
                                    swal("错误", "手机号不正确！", "error");
                                }
                            } else {
                                swal("公司不存在", "请重新填写公司名", "error");
                            }
                        });
                    }
                });

                if (phone) {
                    phoneCamera.on("change", function() {
                        var files = event.target.files,
                            file;
                        if (files && files.length > 0) {
                            file = files[0];
                            try {
                                var url = null;
                                if (window.createObjectURL != undefined) { // basic
                                    url = window.createObjectURL(file);
                                } else if (window.URL != undefined) { // mozilla(firefox)
                                    url = window.URL.createObjectURL(file);
                                } else if (window.webkitURL != undefined) { // webkit or chrome
                                    url = window.webkitURL.createObjectURL(file);
                                }
                            } catch (e) {
                                try {
                                    var fileReader = new FileReader();
                                    fileReader.onload = function(event) {　　　　 // 获取照片的base64编码
                                        compressPicture(event.target.result);　　 // 压缩照片
                                    };
                                    fileReader.readAsDataURL(file);
                                } catch (e) {
                                    alert(common.MESSAGE.title.error, '拍照失败,请联系客服或尝试更换手机再试!');
                                }
                            }
                        }
                        var image = new Image();
                        var quality = 0.8;
                        image.src = url;
                        image.onload = function() {
                            var that = this;
                            // 生成比例
                            var width = that.width,
                                height = that.height;
                            width = width / 4;
                            height = height / 4;
                            // 生成canvas画板
                            var canvas = document.createElement('canvas');
                            var ctx = canvas.getContext('2d');
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(that, 0, 0, width, height);
                            // 生成base64,兼容修复移动设备需要引入mobileBUGFix.js
                            var imgurl = canvas.toDataURL('image/png', quality);
                            // 修复IOS兼容问题
                            if (navigator.userAgent.match(/iphone/i)) {
                                var mpImg = new MegaPixImage(image);
                                mpImg.render(canvas, {
                                    maxWidth: width,
                                    maxHeight: height,
                                    quality: quality
                                });
                                imgurl = canvas.toDataURL('image/png', quality);
                            }
                            if (dirname == null) {
                                uploadpath = '../faceinform/';
                                newfile = true;
                            } else {
                                uploadpath = '../faceinform/' + dirname;
                                newfile = false;
                            }
                            $.ajax({
                                type: "POST",
                                url: "/tp5/public/static/camera/upload.php",
                                cache: false,
                                data: {
                                    imgData: imgurl,
                                    dir: uploadpath,
                                    isnew: newfile
                                },
                                success: function(data) {
                                    back = JSON.parse(data);
                                    if (back.status == 1) {
                                        //进行检测多张人脸之间的相似度
                                        if (old_img != null) {
                                            $.ajax({
                                                type: "POST",
                                                url: "/tp5/public/static/camera/facecheckforregister.php",
                                                cache: false,
                                                data: {
                                                    face1: old_img,
                                                    face2: back.filename,
                                                    dir: dirname
                                                },
                                                success: function(re) {
                                                    //检测通过
                                                    re = JSON.parse(re);
                                                    if (re.status == 1) {
                                                        console.log("检测通过");
                                                        //增加有效人脸数量
                                                        face_number++;
                                                        if (face_number < max_face_number) {
                                                            $("#facepath").val("成功!还能采集" + (max_face_number - face_number) + "张人脸");
                                                        } else {
                                                            phoneCamera.attr("disabled", "disabled");
                                                            $("#facepath").val("成功!已经达到采集上限");
                                                        }
                                                        //更新上一张人脸的保存数据
                                                        old_img = back.filename;
                                                        if (dirname == null) dirname = back.dir;
                                                    } else {
                                                        console.log("检测失败");
                                                        $("#facepath").val("失败!请重新采集");
                                                    }
                                                }
                                            })
                                        } else {
                                            //增加有效人脸数量
                                            face_number++;
                                            if (face_number < max_face_number) {
                                                $("#facepath").val("成功!还能采集" + (max_face_number - face_number) + "张人脸");
                                            } else {
                                                phoneCamera.attr("disabled", "disabled");
                                                $("#facepath").val("成功!已经达到采集上限");
                                            }
                                            //更新上一张人脸的保存数据
                                            old_img = back.filename;
                                            if (dirname == null) dirname = back.dir;
                                        }
                                    } else {
                                        $("#facepath").val("请重新采集");
                                    }
                                },
                            });
                        };
                        ////////////
                    })
                } else {
                    $("#collectFace").on('click', function() {
                        console.log('take picture');
                        var img = camera.take();
                        if (dirname == null) {
                            uploadpath = '../faceinform/';
                            newfile = true;
                        } else {
                            uploadpath = '../faceinform/' + dirname;
                            newfile = false;
                        }
                        $.post('/tp5/public/static/camera/upload.php', {
                            imgData: img.src,
                            dir: uploadpath,
                            isnew: newfile
                        }).done(function(data) {
                            back = JSON.parse(data)
                            if (back.status == 1) {
                                //进行检测多张人脸之间的相似度
                                if (old_img != null) {
                                    $.post('/tp5/public/static/camera/facecheckforregister.php', {
                                        face1: old_img,
                                        face2: back.filename,
                                        dir: dirname
                                    }).done(function(re) {
                                        //检测通过
                                        re = JSON.parse(re);
                                        if (re.status == 1) {
                                            console.log("检测通过");
                                            //增加有效人脸数量
                                            face_number++;
                                            if (face_number < max_face_number) {
                                                $("#collectFace").text("成功!还能采集" + (max_face_number - face_number) + "张人脸");
                                            } else {
                                                $("#collectFace").attr("disabled", "disabled");
                                                $("#collectFace").text("成功!已经达到采集上限");
                                            }
                                            //更新上一张人脸的保存数据
                                            old_img = back.filename;
                                            if (dirname == null) dirname = back.dir;
                                        } else {
                                            console.log("检测失败");
                                            $("#collectFace").text("失败!请重新采集");
                                        }
                                    });
                                } else {
                                    //增加有效人脸数量
                                    face_number++;
                                    if (face_number < max_face_number) {
                                        $("#collectFace").text("成功!还能采集" + (max_face_number - face_number) + "张人脸");
                                    } else {
                                        $("#collectFace").attr("disabled", "disabled");
                                        $("#collectFace").text("成功!已经达到采集上限");
                                    }
                                    //更新上一张人脸的保存数据
                                    old_img = back.filename;
                                    if (dirname == null) dirname = back.dir;
                                }
                            } else {
                                $("#collectFace").text("请重新采集");
                            }
                        })
                    });
                }

                ///////
            });

            $("#next").click(function() {

                $(".stepone").removeClass("animated fadeInUp");
                $(".stepone").addClass("animated zoomOut");

                $(".steptwo").removeClass("animated zoomOut");
                $(".steptwo").addClass("animated fadeInUp");
                $(".steptwo").show();
                if (!phone) {
                    $('#false_camera').show(); //显示摄像头
                    $('div.photo').addClass('camera');
                    $('div.photo').removeClass('photo');
                }

            });
            $("#previous").click(function() {


                $(".steptwo").removeClass("animated fadeInUp");
                $(".steptwo").addClass("animated zoomOut");
                $(".steptwo").hide();

                $(".stepone").removeClass("animated zoomOut");
                $(".stepone").addClass("animated fadeInUp");


                $('#false_camera').hide(); //显示摄像头
                $('div.camera').addClass('photo');
                $('div.photo').removeClass('camera');
            });
            if (window.screen.width < 768) {
                $(".form-control").css({
                    "width": $(".login").width() * 0.85
                });
            }
        </script>
</body>

</html>